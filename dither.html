<head>
    
    <script type="text/javascript" src="pixel.js"></script>
    <script type="text/javascript" src="palette.js"></script>

    </head>
    <body>
      <canvas id="myCanvas" width="640" height="640" style="background-color:FFFFF; "></canvas>
      <script>



        function animate(canvas, context,startTime) {

            context.clearRect(0, 0, canvas.width, canvas.height);

            context.drawImage(image, 0, 0);
            var imageData = context.getImageData(0, 0, 640, 640);
            var data = imageData.data;

            var imageWidth  = image.width;
            var imageHeight = image.height;


            for(var y = 0; y < imageHeight; y++) {
              for(var x = 0; x < imageWidth; x++) {

                var red = data[((imageWidth * y) + x) * 4];
                var green = data[((imageWidth * y) + x) * 4 + 1];
                var blue = data[((imageWidth * y) + x) * 4 + 2];
              
                var oldPixel = new pixel(red, green, blue);

                var newPixel = find_closest_palette_color(oldPixel);

                data[((imageWidth * y) + x) * 4]     = newPixel.c.r;
                data[((imageWidth * y) + x) * 4 + 1] = newPixel.c.g;
                data[((imageWidth * y) + x) * 4 + 2] = newPixel.c.b;

                var errorPixel = oldPixel.sub(newPixel);


                if(x + 1 < imageWidth){
                    var y_;
                    var x_;
                    var p_ = new pixel();
                    var setPixel;
                    
                    x_ = x + 1;
                    y_ = y;

                    p_.c.r = data[((imageWidth * y_) + x_) * 4]      
                    p_.c.g = data[((imageWidth * y_) + x_) * 4 + 1]  
                    p_.c.b = data[((imageWidth * y_) + x_) * 4 + 2]  

                    var E_7_16 = errorPixel.mult(0.4375);

                    setPixel = p_.add(E_7_16);

                    data[((imageWidth * y_) + x_) * 4]      = setPixel.c.r;
                    data[((imageWidth * y_) + x_) * 4 + 1]  = setPixel.c.g;
                    data[((imageWidth * y_) + x_) * 4 + 2]  = setPixel.c.b;
                }


                if(x - 1 >= 0 && y + 1 < imageHeight){
                    x_ = x - 1;
                    y_ = y + 1;

                    p_.c.r = data[((imageWidth * y_) + x_) * 4]      
                    p_.c.g = data[((imageWidth * y_) + x_) * 4 + 1]  
                    p_.c.b = data[((imageWidth * y_) + x_) * 4 + 2]  

                    var E_3_16 = errorPixel.mult(0.1875);

                    setPixel = p_.add(E_3_16);

                    data[((imageWidth * y_) + x_) * 4]      = setPixel.c.r;
                    data[((imageWidth * y_) + x_) * 4 + 1]  = setPixel.c.g;
                    data[((imageWidth * y_) + x_) * 4 + 2]  = setPixel.c.b;
                }   

                if(y + 1 < imageHeight){
                    x_ = x;
                    y_ = y + 1;

                    p_.c.r = data[((imageWidth * y_) + x_) * 4]      
                    p_.c.g = data[((imageWidth * y_) + x_) * 4 + 1]  
                    p_.c.b = data[((imageWidth * y_) + x_) * 4 + 2]  

                    var E_5_16 = errorPixel.mult(0.3125);

                    setPixel = p_.add(E_5_16);

                    data[((imageWidth * y_) + x_) * 4]      = setPixel.c.r;
                    data[((imageWidth * y_) + x_) * 4 + 1]  = setPixel.c.g;
                    data[((imageWidth * y_) + x_) * 4 + 2]  = setPixel.c.b;
                }

                if(y + 1 < imageHeight && x + 1 < imageWidth){
                    x_ = x + 1;
                    y_ = y + 1;

                    p_.c.r = data[((imageWidth * y_) + x_) * 4]      
                    p_.c.g = data[((imageWidth * y_) + x_) * 4 + 1]  
                    p_.c.b = data[((imageWidth * y_) + x_) * 4 + 2]  

                    var E_1_16 = errorPixel.mult(0.0625);

                    setPixel = p_.add(E_1_16);

                    data[((imageWidth * y_) + x_) * 4]      = setPixel.c.r;
                    data[((imageWidth * y_) + x_) * 4 + 1]  = setPixel.c.g;
                    data[((imageWidth * y_) + x_) * 4 + 2]  = setPixel.c.b;
                }


              }
            }
            context.putImageData(imageData, 0, 0 );


            // requestAnimationFrame(function() {
            //   animate(canvas, context, startTime);
            // });
        }


        var image = new Image();
        image.src = "me.jpg";

        var logged = false;
        

        var canvas = document.getElementById('myCanvas');
        var context = canvas.getContext('2d');

        var startTime = (new Date()).getTime();
        animate(canvas, context,startTime);

        image.onload = function(){
            animate(canvas, context, startTime);
        }

      </script>
</body>